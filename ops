{"version":1,"ops":[{"type":1,"author":{"id":"32aba62f1c2d9425249e944212d65defb7461ffb"},"timestamp":1497380428,"metadata":{"github-id":"MDU6SXNzdWUyMzU2NTcyMjY=","github-url":"https://github.com/DFHack/dfhack/issues/1109","origin":"github"},"title":"create-unit error if called while an announcement popup is shown","message":"Calling create-unit while an popup announcement is awaiting user to \"click enter to close window\", give an error and leaves dwarf fortress in a pseudo arena-mode state.\n\nSteps to reproduce (from a dfhack console):\n1. lua\n2. dfhack.gui.showPopupAnnouncement(\"foo\", COLOR_RED)\n3. quit\n4. modtools/create-unit -race GOBLIN -caste MALE\n\nNo goblin is spawned. And I get the following error:\n```\n/df/hack/scripts/modtools/create-unit.lua:121: Cannot read field viewscreen_dwarfmodest.race: not found.\nstack traceback:\n        [C]: in metamethod '__index'\n        /df/hack/scripts/modtools/create-unit.lua:121: in global 'createUnit'\n        /df/hack/scripts/modtools/create-unit.lua:288: in global 'createUnitInCiv'\n        /df/hack/scripts/modtools/create-unit.lua:509: in local 'script_code'\n        ./hack/lua/dfhack.lua:562: in function 'dfhack.run_script_with_env'\n        (...tail calls...)\n```\n\nAfter the error the unit list In dwarf fortress only shows first names of the dwarves.\n\nOne fix is to not try to spawn the unit if an announcement popup is shown. But I could not figure out how to check for that. And a minor concern with this fix is how will scripts calling create-unit know whether a unit was spawned.","files":null}]}