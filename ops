{"version":1,"ops":[{"type":1,"author":{"id":"d4ba99f16422e9377de56dab81d2b84415f00388"},"timestamp":1581555058,"metadata":{"github-id":"MDU6SXNzdWU1NjQzNzAzOTc=","github-url":"https://github.com/DFHack/dfhack/issues/1494","origin":"github"},"title":"Exportlegends sites/all","message":"Then using the `exportlegends all` command it fails while doing the export.\n### Error message\n```\n~/df_linux/hack/scripts/exportlegends.lua:813: Cannot write field viewscreen_export_graphical_mapst.sel_idx: not found.\nstack traceback:\n\t[C]: in metamethod '__newindex'\n\t~/df_linux/hack/scripts/exportlegends.lua:813: in function \u003c~/df_linux/hack/scripts/exportlegends.lua:802\u003e\n```\n\n### Code inspection\nOpening the `exportlegends.lua` file it files in the function export_detailed_maps() (line 801-821):\n```\nfunction export_detailed_maps()\n    script.start(function()\n        for i = 1, #MAPS do\n            local vs = dfhack.gui.getViewscreenByType(df.viewscreen_export_graphical_mapst, 0)\n            if not vs then\n                local legends_vs = dfhack.gui.getViewscreenByType(df.viewscreen_legendsst, 0)\n                    or qerror(\"Could not find legends screen\")\n                gui.simulateInput(legends_vs, 'LEGENDS_EXPORT_DETAILED_MAP')\n            end\n\n            vs = dfhack.gui.getViewscreenByType(df.viewscreen_export_graphical_mapst, 0)\n                or qerror(\"Could not find map export screen\")\n            -- FAIL ON NEXT LINE --\n            vs.sel_idx = i - 1\n            -- FAIL ON LINE ABOVE --\n            print('    Exporting map: ' .. MAPS[i])\n            gui.simulateInput(vs, 'SELECT')\n            while dfhack.gui.getCurViewscreen() == vs do\n                script.sleep(10, 'frames')\n            end\n        end\n    end)\nend\n```\n### Quick fix\nI commented out line 813. So the old code was:\n```\n            vs = dfhack.gui.getViewscreenByType(df.viewscreen_export_graphical_mapst, 0)\n                or qerror(\"Could not find map export screen\")\n            vs.sel_idx = i - 1\n            print('    Exporting map: ' .. MAPS[i])\n```\nNew code:\n\n```\n            vs = dfhack.gui.getViewscreenByType(df.viewscreen_export_graphical_mapst, 0)\n                or qerror(\"Could not find map export screen\")\n            -- vs.sel_idx = i - 1\n            print('    Exporting map: ' .. MAPS[i])\n```\nThis fixed the problem for me and was able to export the maps after this.\nThis might have other implications but not familiar enough with this code to tell.\n(Note: ?? numbering of exporting files might be off ??)","files":null}]}