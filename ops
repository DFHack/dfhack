{"version":1,"ops":[{"type":1,"author":{"id":"98ad57fe0d800be919d8a277746497716d5aba02"},"timestamp":1582778394,"metadata":{"github-id":"MDU6SXNzdWU1NzE4MTY1NDc=","github-url":"https://github.com/DFHack/dfhack/issues/1507","origin":"github"},"title":"questport not working for 47.xx due to outdated code","message":"ok so since UI_advmode got new descriptors for some of the data this broke quest port this should fix it.\n\n```\n--Sends your adventurer to the location of your quest log cursor.\n--[====[\n\nquestport\n=========\nSends your adventurer to the location of your quest log cursor.\nUsable from travel mode or on foot.\nDon't try to travel normally while in forbidden travel areas (mountains, lairs) and you can questport out.\n\n]====]\nlocal gui = require 'gui'\nlocal qp = dfhack.gui.getViewscreenByType(df.viewscreen_dungeonmodest, 0)\n    or qerror(\"Could not find main adventure mode screen\")\nlocal qmap = dfhack.gui.getViewscreenByType(df.viewscreen_adventure_logst, 0)\n    or qerror(\"Could not find quest log screen\")\nlocal qarm = df.global.world.armies.all\n\nlocal qx = qmap.cursor_x * 48\nlocal qy = qmap.cursor_y * 48\nlocal rx = qmap.player_region_x * 48\nlocal ry = qmap.player_region_y * 48\ndf.global.ui_advmode.travel_origin_x = qx\ndf.global.ui_advmode.travel_origin_y = qy\nif df.global.ui_advmode.menu == df.ui_advmode_menu.Default then\n    gui.simulateInput(qp.child, 'LEAVESCREEN')\n    df.global.ui_advmode.menu = df.ui_advmode_menu.Travel\n    df.global.ui_advmode.travel_not_moved = true\n    gui.simulateInput(qp, 'CURSOR_DOWN')\n    dfhack.timeout(15, 'frames', function()\n        gui.simulateInput(qp, 'A_TRAVEL_LOG')\n    end)\nelseif df.global.ui_advmode.menu == df.ui_advmode_menu.Travel then\n    for k,v in ipairs(qarm) do\n        if v.flags.player then\n            local my_arm = v.pos\n            if rx ~= qx or ry ~= qy then\n                my_arm.x = qx\n                my_arm.y = qy\n                qmap.player_region_x = qmap.cursor_x\n                qmap.player_region_y = qmap.cursor_y\n            end\n        end\n    end\nend\n```","files":null}]}