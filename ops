{"version":1,"ops":[{"type":1,"author":{"id":"7cf2343c4a480a96e96a250a86505180415e6116"},"timestamp":1358261621,"metadata":{"github-id":"MDU6SXNzdWU5OTgwNzkw","github-url":"https://github.com/DFHack/dfhack/issues/180","origin":"github"},"title":"stonesense plugin not loading on osx mountain lion","message":"It seems there are two issues with the current osx release: the zip archive has broken links, and a library path is missing in `dfhack` script. Here is some description:\n\nWhen I run dfhack I get this error while trying to load the stonesense plugin:\n\n```\ndlopen(/Users/Diogo/Documents/dwarves/df_osx/hack/plugins/stonesense.plug.so, 2): Library not loaded: @executable_path/stonesense/deplibs/liballegro.5.0.dylib\n  Referenced from: /Users/Diogo/Documents/dwarves/df_osx/hack/plugins/stonesense.plug.so\n  Reason: image not found\nCan't load plugin /Users/Diogo/Documents/dwarves/df_osx/hack/plugins/stonesense.plug.so\n```\n\nInvestigating I found that all the symbolic links inside stonesense/deplibs are broken:\n\n```\n$ find . -type l | xargs file\n./liballegro.5.0.dylib:            broken symbolic link to liballegro.5.0.7\n./liballegro_acodec.5.0.dylib:     broken symbolic link to liballegro_acodec.5.0.7\n./liballegro_audio.5.0.dylib:      broken symbolic link to liballegro_audio.5.0.7\n./liballegro_color.5.0.dylib:      broken symbolic link to liballegro_color.5.0.7\n./liballegro_dialog.5.0.dylib:     broken symbolic link to liballegro_dialog.5.0.7\n./liballegro_font.5.0.dylib:       broken symbolic link to liballegro_font.5.0.7\n./liballegro_image.5.0.dylib:      broken symbolic link to liballegro_image.5.0.7\n./liballegro_main.5.0.dylib:       broken symbolic link to liballegro_main.5.0.7\n./liballegro_memfile.5.0.dylib:    broken symbolic link to liballegro_memfile.5.0.7\n./liballegro_physfs.5.0.dylib:     broken symbolic link to liballegro_physfs.5.0.7\n./liballegro_primitives.5.0.dylib: broken symbolic link to liballegro_primitives.5.0.7\n./liballegro_ttf.5.0.dylib:        broken symbolic link to liballegro_ttf.5.0.7\n./libfreetype.dylib:               broken symbolic link to libfreetype.6\n```\n\n(I redownloaded the latest zip distribution archive and extracted the files with `unzip` command line program, in case the osx gui extractor I use where the cause)\n\nThen I fixed the broken links with:\n\n```\nln -s -f ./liballegro.5.0.7.dylib ./liballegro.5.0.dylib\nln -s -f ./liballegro_acodec.5.0.7.dylib ./liballegro_acodec.5.0.dylib\nln -s -f ./liballegro_audio.5.0.7.dylib ./liballegro_audio.5.0.dylib\nln -s -f ./liballegro_color.5.0.7.dylib ./liballegro_color.5.0.dylib\nln -s -f ./liballegro_dialog.5.0.7.dylib ./liballegro_dialog.5.0.dylib\nln -s -f ./liballegro_font.5.0.7.dylib ./liballegro_font.5.0.dylib\nln -s -f ./liballegro_image.5.0.7.dylib ./liballegro_image.5.0.dylib\nln -s -f ./liballegro_main.5.0.7.dylib ./liballegro_main.5.0.dylib\nln -s -f ./liballegro_memfile.5.0.7.dylib ./liballegro_memfile.5.0.dylib\nln -s -f ./liballegro_physfs.5.0.7.dylib ./liballegro_physfs.5.0.dylib\nln -s -f ./liballegro_primitives.5.0.7.dylib ./liballegro_primitives.5.0.dylib\nln -s -f ./liballegro_ttf.5.0.7.dylib ./liballegro_ttf.5.0.dylib\nln -s -f ./libfreetype.6.dylib ./libfreetype.dylib\n```\n\nNow I get this error in stderr:\n\n```\ndlopen(/Users/Diogo/Documents/dwarves/df_osx/hack/plugins/stonesense.plug.so, 2): Library not loaded: /opt/local/lib/libfreetype.6.dylib\n  Referenced from: /Users/Diogo/Documents/dwarves/df_osx/./stonesense/deplibs/liballegro_ttf.5.0.dylib\n  Reason: no suitable image found.  Did find:\n    /usr/local/lib/libfreetype.6.dylib: mach-o, but wrong architecture\n```\n\n(I have Homebrew's libfreetype, but unfortunately its only 64 bit)\n\nIt seems libfreetype inside stonesense/deplibs isn't being found. So I included its path to `dfhack` script:\n\n```\nexport DYLD_LIBRARY_PATH=${PWD}/hack:${PWD}/libs:${PWD}/stonesense/deplibs\n```\n\nThen dfhack could load stonesense plugin.","files":null}]}