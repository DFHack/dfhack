{"version":1,"ops":[{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1429964733,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI4OTkzMTU3Mg=="},"added":["bug"],"removed":[]},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1429987601,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDk2MjU4ODg0","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-96258884"},"message":"There are [a few other places](https://github.com/DFHack/dfhack/blob/a1fd1d9219883470aff60feb0ebabb79e78741d7/library/modules/Units.cpp#L1287-L1298) where 0 could be returned - have you verified that none of those conditions are true?","files":null},{"type":3,"author":{"id":"bd8c10440c0a71a1d8096ede1925592c711af037"},"timestamp":1429988280,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDk2MjYyMTg4","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-96262188"},"message":"No.  I'll look at the code some more.","files":null},{"type":3,"author":{"id":"bd8c10440c0a71a1d8096ede1925592c711af037"},"timestamp":1430011593,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDk2MzAwNjc3","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-96300677"},"message":"I built and installed from the current repository and made some code changes to narrow down where the problem is.  (I've never invested the time to learn a debugger.)\n\nThere are four returns in the function: three conditional returns right at the top, and the one I previously mentioned right at the bottom.\n\nThe following tests were made all starting from the same Dwarf Mode save, which I don't think is the same one I was using when I first posted\n\nRight after the three returns at the top I added a `return 1;` and got 1 for everyone, so none of my current dorfs are returning 0 due to any of those conditions.\n\nI changed that line to `return speed;` and then got 0 for everyone, so it looks like `craw-\u003emisc.speed` is where they are picking the zeros up.  (It's the only assignment or manipulation of `speed` before that temporary return.)\n\nI deleted that return and changed the return near the end to a simple `return speed;` rather than the bounded value, and still get 0 for almost everyone.  (One dorf returns a value of 2144, and he turns out to be sleeping.)\n\nModifications to `speed` in the code after setting it to `craw-\u003emisc.speed` are either additions or multiplications/divisions.  The latter won't make any difference since they are starting with 0 (per above), but the adds could explain why the sleeper gets a higher number.  (There is a call to `adjust_speed_rating` with a `sleepiness_timer` argument, and that function can provide adds, so maybe that's why the sleeper gets a non-zero value.)\n\nI started a new game, leaving dfhack built to return the raw (unbounded) speed.  One individual started with a speed of 50.  After unpausing, two more briefly picked up non-zero speeds, but then went back to zero.  None showed a job or a curse.  I created a stockpile so they would all get busy moving stuff, and all seven speeds went to zero when their jobs were \"store item in stockpile\".  When they went back to idle, all their speeds were zero except one who briefly showed a value of 42.\n\nMy best guess at this point is that `craw-\u003emisc.speed` is the problem.","files":null},{"type":3,"author":{"id":"bd8c10440c0a71a1d8096ede1925592c711af037"},"timestamp":1430012042,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDk2MzAzMTU4","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-96303158"},"message":"BTW, the 2144 is a reasonable speed (based on my experience with 0.34), though IIRC sleepers used to show very slow speeds.  The values 42 and 50 represent extremely high speeds.  I suspect they represent modifiers added to an incorrect zero base value.\n\n(I just edited the previous post to change \"reasonable speeds\" to \"non-zero speeds\" for these numbers.)","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1448217696,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDQ3MTU0ODI5Ng=="},"added":["structures"],"removed":[]},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1448217757,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDE1ODc4Nzk1NQ==","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-158787955"},"message":"Looks like outdated structures to me, although some field names are correct - here's `craw.misc` for a random dwarf:\n\n```\nlitter_size_min          = 3\nlitter_size_max          = 1\npenetratepower           = 0\nvermin_bite_chance       = 0\ngrasstrample             = 5\nbuildingdestroyer        = 0\nitemcorpse_itemtype      = -17040\nitemcorpse_itemsubtype   = -28694\nitemcorpse_materialtype  = -17580\nitemcorpse_materialindex     = -28694\nitemcorpse_quality       = 0\nremains_color            = \u003cint16_t[]: 0x1491c0b6\u003e\ndifficulty               = 1\ncaste_glowcolor          = \u003cint16_t[]: 0x1491c0be\u003e\nbeach_frequency          = 0\nclutch_size_min          = 1\nclutch_size_max          = 3\nvision_arc_min           = 60\nvision_arc_max           = 120\nspeed                    = -1880442884\nmodvalue                 = 1\npetvalue                 = 1\nmilkable                 = 100800\nviewrange                = 20\nmaxage_min               = 150\nmaxage_max               = 170\nbaby_age                 = 1\nchild_age                = 12\nswim_speed               = -1880441108\ntrade_capacity           = 1000\nunk4                     = 142\npop_ratio                = 50\nadult_size               = 6000\nbone_mat                 = 22\nbone_matidx              = 465\nfish_mat_index           = -1\negg_mat_index            = -1\nattack_trigger           = \u003cint32_t[]: 0x1491c118\u003e\negg_size                 = 50\ngrazer                   = -1\npetvalue_divisor         = 1\nprone_to_rage            = 0\nunk6                     = \u003cint32_t[]: 0x1491c134\u003e\n```","files":null},{"type":3,"author":{"id":"bd8c10440c0a71a1d8096ede1925592c711af037"},"timestamp":1448234746,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDE1ODgxNzk5Mw==","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-158817993"},"message":"Lots of {0,1,2,4,8} in that number.  I wonder whether some subset of the bits give the number we want, with the negative coming from a numeric overflow caused by using too many of the bits.\n\nDo you know how the offsets were obtained?","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1448239109,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDE1ODgyMzA1NQ==","github-url":"https://github.com/DFHack/dfhack/issues/607#issuecomment-158823055"},"message":"https://github.com/DFHack/df-structures/blob/1bc4f6133c8a5bbd397001f97647c15724317e07/df.creature-raws.xml#L779-L788\nI'm surprised nobody noticed the \"no longer used\" comments before (they're also in the generated headers, if you're interested). There should be a different way to obtain speed data as of 0.40.01 (with the new gaits, etc.).","files":null}]}