{"version":1,"ops":[{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595853306,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDM2OTExOQ==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664369119"},"message":"The 64-bit Mac build should use your system Ruby, actually (not one you've installed through a package manager, though). Can you run devel/lsmem and paste its output to see what Ruby is loaded?","files":null},{"type":3,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595853823,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDM3MjU3Ng==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664372576"},"message":"Thank you.\n\nI do not find any external ruby in this\n[lsmem.txt](https://github.com/DFHack/dfhack/files/4982027/lsmem.txt)\n\n.","files":null},{"type":6,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595853823,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg4NjE0OTU0"},"target":"9b6f2c0a657b8ef3abc4395c4f3d8da5c3c3c2929f092359474f40a53f551fc7","message":"Thank you.\n\nI do not find any external ruby in this.\n\n[lsmem.txt](https://github.com/DFHack/dfhack/files/4982027/lsmem.txt)\n\n[enc.txt](https://github.com/DFHack/dfhack/files/4982037/enc.txt)","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595857757,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDQwODA3OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664408079"},"message":"That's weird, it should definitely list something else with \"ruby\" in its name, besides hack/plugins/ruby.plug.dylib. Did you run devel/lsmem before all of the plugins had loaded? Could you try running it after running some Ruby code in DFHack?\n\nHere's the list of files the Ruby plugin tries to load on macOS: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/plugins/ruby/ruby.cpp#L330-L331\nYou could try to see if either of these exist, and what Ruby version they correspond to if so.","files":null},{"type":3,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595884386,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDY0MTAwMw==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664641003"},"message":"`/System/Library/Frameworks/Ruby.framework/Ruby` exists. But no `hack/libruby.dylib`.\n\nAfter running ruby code, I tried running unmodified dfhack, also in /Applications, and same result.\n\nHow do I run devel/lsmem before plugins loaded? Running `reload ruby` causes error: `dfhack: line 27: 36512 Bus error: 10           DYLD_INSERT_LIBRARIES=./hack/libdfhack.dylib ./dwarfort.exe \"$@\"`\n\n```/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby --version\nruby 2.6.3p62 (2019-04-16 revision 67580) [universal.x86_64-darwin19]","files":null},{"type":6,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595884386,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg4NzUxMzU0"},"target":"b5b9d97d718d35c21c0ca0ca7c31f399d41cca6d1bfdb85ec723782a4bf94389","message":"`/System/Library/Frameworks/Ruby.framework/Ruby` exists. But no `hack/libruby.dylib`.\n\nAfter running ruby code, I tried running unmodified dfhack, also in /Applications, and same result.\n\nHow do I run devel/lsmem before plugins loaded? Running `reload ruby` causes error: `dfhack: line 27: 36512 Bus error: 10           DYLD_INSERT_LIBRARIES=./hack/libdfhack.dylib ./dwarfort.exe \"$@\"`\n\n`/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby --version`\n\n`ruby 2.6.3p62 (2019-04-16 revision 67580) [universal.x86_64-darwin19]`","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595893061,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDY5MjM0Mw==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664692343"},"message":"Sorry, I was asking you to run `devel/lsmem` *after* plugins had loaded. And by \"run Ruby code\", I mean run it in DFHack. For example, run the `lever` command in DFHack, or run `:rb puts 1` and see if it prints `1`. Then run `devel/lsmem` after that and see if anything else Ruby-related shows up (specifically anything under `/System`).\n\nThe \"bus error\" is a crash, which is definitely not supposed to happen, and isn't good. Does it also occur if you try to run Ruby code in DFHack (last paragraph)?\n\n`hack/libruby.dylib` looks like it's only distributed for 32-bit macOS builds, so the fact that it's missing for you is expected (and fine). I'm wondering if macOS 10.15 is blocking access to the Ruby framework for some reason, though. Can you try `cp /System/Library/Frameworks/Ruby.framework/Ruby hack/libruby.dylib` and see if that changes anything?","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595893077,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM1OTIwMjM2MzM="},"added":["ruby"],"removed":[]},{"type":3,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595893708,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDY5NTMxNA==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664695314"},"message":"I did run after plugins loaded I think, in dfhack prompt. I guess the way to run before is in init file. I do not know how it would be possible to not run after plugins load.\n\nCopying the system library to `hack/` does show the library in `devel/lsmem`. `reload ruby` does not crash, but it does not change output of `rb puts Encoding.list`.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595897492,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDcxMjczMg==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664712732"},"message":"Yeah, I'm also not sure what I meant about running something before plugins load. I know it's possible to interact with the DF window before all plugins have loaded, since it takes some time, but I don't think you can interact with the console that early. Disregard.\n\nOut of curiosity, what does `:rb puts RUBY_VERSION` print?\n\nIt seems that we still use Ruby 1.8.7 on Linux (and 32-bit Windows, I think), which doesn't even *have* the built-in `Encoding` class:\n```\n[DFHack]# :rb puts Encoding.list\nE: NameError: (eval): uninitialized constant Encoding\n (eval)\n```\nWe should probably standardize on a single version of Ruby across platforms. Evidently we can't rely on the system Ruby on macOS behaving properly either. I'm not sure how complicated it'll be to build `libruby`s that are portable enough for our needs.\n\nI assume \"IBM437\" is what DF+DFHack refer to as [CP437](https://dwarffortresswiki.org/index.php/CP437), yes? We do have existing functions to convert between that and UTF-8, but they're currently only available to C++ and Lua. It shouldn't be hard to expose them to Ruby, although I'm far from an expert on how Ruby encodings work.","files":null},{"type":3,"author":{"id":"e4bf8bd4d5e909340d062464050b953afa8cd4e7"},"timestamp":1595899337,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDcyMTQwMA==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664721400"},"message":"I see. Thank you.\n\nIs there a difference between at the prompt `rb` and `:rb`?\n\n`rb puts RUBY_VERSION` \u003e `2.6.3`\nThis is the system ruby version. I thought there was another installed in /usr/local.\n\nI have been using encoding conversion in Lua, but Lua is frustrating. If I write conversion in Ruby I will share.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595904966,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2NDc0NTgyOQ==","github-url":"https://github.com/DFHack/dfhack/issues/1613#issuecomment-664745829"},"message":"The `:` treats everything after the command as a single argument (including whitespace verbatim): https://docs.dfhack.org/en/stable/docs/Core.html#using-dfhack-commands\nThe `lua` command needs this for expressions that have spaces in it (although running `lua` with no arguments starts an interpreter, which is easier to use), but it looks like `rb` usually joins multiple arguments without needing the `:`.\n\nIf you're interested in adding encoding conversion, these are the relevant functions: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/library/include/MiscUtils.h#L399-L401\nAnd here's an example of a C function in the ruby plugin that takes a string: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/plugins/ruby/ruby.cpp#L566-L573\nand one that returns a string: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/plugins/ruby/ruby.cpp#L856-L860","files":null},{"type":6,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595904966,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg4ODEwNjgx"},"target":"6d91f005b1f42d53e33b45b145c584730cf91c7871d8a519b475527043a1fade","message":"The `:` treats everything after the command as a single argument (including whitespace verbatim): https://docs.dfhack.org/en/stable/docs/Core.html#using-dfhack-commands\nThe `lua` command needs this for expressions that have spaces in it (although running `lua` with no arguments starts an interpreter, which is easier to use), but it looks like `rb` usually joins multiple arguments without needing the `:`.\n\nThe Ruby plugin will only look for the two libraries I linked earlier on macOS (the one in `hack` and the one in `/System`). If you change the plugin to look somewhere else and recompile, it could pick up one from somewhere else, though.\n\nIf you're interested in adding encoding conversion, these are the relevant functions: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/library/include/MiscUtils.h#L399-L401\nAnd here's an example of a C function in the ruby plugin that takes a string: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/plugins/ruby/ruby.cpp#L566-L573\nand one that returns a string: https://github.com/DFHack/dfhack/blob/289e0df828297b75a96fef2d1132ca7aa7de890e/plugins/ruby/ruby.cpp#L856-L860","files":null}]}