{"version":1,"ops":[{"type":1,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1541340406,"metadata":{"github-id":"MDU6SXNzdWUzNzcxNTYyNDk=","github-url":"https://github.com/DFHack/dfhack/issues/1412","origin":"github"},"title":"Buildings:: constructAbstract seems to exclude trees from gathering zones when those are created","message":"I'm not completely sure what's going on, or whether I am the one doing something incorrectly.\n\nI've tried to use a Lua script to create a gathering zone around a tree, centered on the tree. However, I either end up with a failure to create the zone, or the tree itself removed from the zone, which ought to cause fruit growing on the trunk to not be gathered.\n\nThe script essentially does this:\n```\nlocal zone = dfhack.buildings.allocInstance (plant.pos, df.building_type.Civzone, df.civzone_type.ActivityZone, -1)\ndfhack.println (dfhack.buildings.setSize (zone, 3, 3, 0))\ndfhack.println (\"Specifying \" .. zone.name, dfhack.buildings.constructAbstract (zone))\n```\n(there are some other fields set as well, but those are probably not of interest here).\nThe first \"println\" prints \"true 3 3 9 8\", where the '8' at the end is likely to be an indication of the issue, as it indicates the tree has been removed from the zone by setSize in that stage. However, the building resulting at the end looks the same as that of a manually created zone, except for zone.room.extents [4] (which probably is \"[1][1]\" if addressed properly), which has a value of 0 for the script created zone and 1 for the manually created one. Setting this field to 1 on the script created one causes \"constructAbstract\" to return false, however, likely because it contains the check\n```\n    if (!checkBuildingTiles(bld, false))\n        return false;\n```\nbut setting it after the abstract building has been constructed seems to work.\n\nThus, I think I can work around the issue for my purposes, but I suspect there is still an issue here.","files":null}]}