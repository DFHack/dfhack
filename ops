{"version":1,"ops":[{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492370237,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2ODkxNw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294368917"},"message":"autounsuspend checks all of the jobs periodically. It looks like your highest job ID is 1193925, which is *really* high - either an indicator that you have a ton of jobs (maybe due to large designations) or something else has gone wrong.\n\nThis should tell you how many jobs are present - mind running it in the console?\n```\n:lua i=0 j=world.job_list while j.next do i=i+1 j=j.next end print(i)\n```","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492370532,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTE0Mg==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369142"},"message":"...So the code unsuspends every 5 ticks if I read it right.   That seems kind of frequent -- shouldn't it really need to run no more than once a second (real time).   At 50 I think (if I understand ticks right), it would trigger once a dwarf hour, which at 100FPS is twice a real second?","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492370573,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTE3NQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369175"},"message":"....nothing.  \n\n```\n[DFHack]# lua i=0 j=world.job_list while j.next do i=i+1 j=j.next end print(i)\n[DFHack]#\n```\n\n(Which can't be true, I have jobs in the job screen, but only a half a dozen screen fulls.)","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492370706,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTI4NQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369285"},"message":"You forgot the colon in the command I gave you.\n\nOne day is 1200 ticks, so that's about right. You could increase the number in `df.onupdate_register('autounsuspend', 5)` and see if that helps.","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492370744,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTMxOA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369318"},"message":"Oh yeah I dropped the colon because it gave an error :)\n```\n\n[DFHack]# :lua i=0 j=world.job_list while j.next do i=i+1 j=j.next end print(i)\n(lua command):1: attempt to index global 'world' (a nil value)\nstack traceback:\n        (lua command):1: in main chunk\n        [C]: in function 'safecall'\n        ...PERIDE~1.03-\\Dwarf Fortress 0.43.03/hack/scripts/lua.lua:79: in function 'f'\n        ...\\PERIDE~1.03-\\Dwarf Fortress 0.43.03\\hack\\lua\\dfhack.lua:562: in function \u003c...\\PERIDE~1.03-\\Dwarf Fortress 0.43.03\\hack\\lua\\dfhack.lua:503\u003e\n        (...tail calls...)\n```","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492370828,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTQwMQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369401"},"message":"What DFHack version are you using? I think the issue is that you're using something before 0.43.05-beta1, not the colon.\n\nEdit: yeah, you're using 0.43.03.\n\nTry this instead:\n```\n:lua i=0 j=df.global.world.job_list while j.next do i=i+1 j=j.next end print(i)\n```","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492371102,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTYzMA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369630"},"message":"PeridexisErrant's Starter Pack 0.43.03-r09\n\n[lua]# i=0 j=df.global.world.job_list while j.next do i=i+1 j=j.next end print(i)\n252543\n\n(Now how do I drop back out of the lua interpreter?)  \n\n(Note: os.exit() is not the right command!)","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492371182,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTY5MA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369690"},"message":"I was looking for the DFHack version, although I'm guessing that's \"0.43.03-r1\". \"quit\" should get you out of the Lua interpreter.\n\nAnyway, 252543 jobs is a lot. Are there that many listed on the jobs screen? If not, do you have a lot of designations?","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492371241,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTc0NQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369745"},"message":"I've got two z-levels designated for mining with the hope that the forgotten beast will be found.  The problem existed before designating those zlevels, but let me undesignate them.","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492371358,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTgzMw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369833"},"message":"How can I see which dfhack is bundled?","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492371543,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM2OTk5OA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294369998"},"message":"I suppose designating two entire z-levels on a 7x7 embark could do it. I'm not sure if there's a faster way to check just the jobs visible in the job list (which are presumably the ones autounsuspend should focus on) or not.\n\nThe DFHack version should be on the title screen, and logged in the DFHack console when DF starts. It should ideally also be in your pack's documentation somewhere. Otherwise, `help` or `:lua print(dfhack.getDFHackVersion())` will tell you.","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492371701,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDExNw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370117"},"message":"0.43.03-r1\n\nHuh.. I did digexp clear on both of those z's ... but...\n\n    # :lua i=0 j=df.global.world.job_list while j.next do i=i+1 j=j.next end print(i)\n    232011","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492371940,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDMyMA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370320"},"message":"I wonder if the root of my FPS is the jobs, and it's just that autounsuspend made it more obvious.  I need to figure out a way to dump those jobs to a text file.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492372070,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDQyMQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370421"},"message":"I think the number of jobs could be a major factor, although it's not necessarily the only thing. Are there a lot listed on the [j]obs screen?","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492372190,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDUxMg==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370512"},"message":"Not hundreds of thousands of jobs in the job screen.  5 screen fulls maybe.\n\n...I'm wondering if my loom dwarf has thousands of webs to collect from the lost FB.  The reveal command showed a lot of webs, but not hundreds of thousands.","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492372483,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDc0Mw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370743"},"message":"# rb df.world.job_list.each { |job|  puts job.job_type }\n\nWhole lot of FellTree ... turning off autochop.\n\n(There's no trees actually designated either - and don't show in the job list.)","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492372752,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MDk2Nw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294370967"},"message":"# rb count = 0; df.world.job_list.each { |job|  if job.job_type == :FellTree then count += 1 end } ; puts \n    count\n    228928","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492375161,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3Mjk2OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294372969"},"message":"Trying to find a way to programmatically cancel those FellTree's ...","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492375273,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3MzA3NA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294373074"},"message":"Looped over the jobs and printed the job.pos:\n\n```\n#\u003cCoord x=232 y=91 z=151\u003e\n#\u003cCoord x=233 y=82 z=151\u003e\n#\u003cCoord x=235 y=92 z=151\u003e\n#\u003cCoord x=235 y=95 z=151\u003e\n#\u003cCoord x=236 y=88 z=151\u003e\n#\u003cCoord x=237 y=81 z=151\u003e\n#\u003cCoord x=237 y=92 z=151\u003e\n#\u003cCoord x=237 y=95 z=151\u003e\n#\u003cCoord x=239 y=80 z=151\u003e\n#\u003cCoord x=239 y=85 z=151\u003e\n#\u003cCoord x=239 y=95 z=151\u003e\n#\u003cCoord x=224 y=106 z=151\u003e\n#\u003cCoord x=225 y=101 z=151\u003e\n#\u003cCoord x=226 y=97 z=151\u003e\n#\u003cCoord x=230 y=96 z=151\u003e\n#\u003cCoord x=230 y=99 z=151\u003e\n#\u003cCoord x=230 y=103 z=151\u003e\n#\u003cCoord x=230 y=109 z=151\u003e\n#\u003cCoord x=235 y=104 z=151\u003e\n#\u003cCoord x=235 y=108 z=151\u003e\n#\u003cCoord x=236 y=97 z=151\u003e\n#\u003cCoord x=238 y=99 z=151\u003e\n#\u003cCoord x=238 y=104 z=151\u003e\n#\u003cCoord x=239 y=105 z=151\u003e\n#\u003cCoord x=239 y=110 z=151\u003e\n#\u003cCoord x=237 y=114 z=151\u003e\n#\u003cCoord x=238 y=122 z=151\u003e\n#\u003cCoord x=239 y=114 z=151\u003e\n0\n[DFHack]#\n```\n\nMy Z in the game only goes up to 139 ...","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492377493,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM3NDg2Mg==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294374862"},"message":"Filtering out z==151, I still have a lot of other Z's ...and some repeats. These are just FellTree:\n\n```\n#\u003cCoord x=168 y=108 z=113\u003e\n#\u003cCoord x=161 y=112 z=113\u003e\n#\u003cCoord x=164 y=117 z=113\u003e\n#\u003cCoord x=165 y=119 z=113\u003e\n#\u003cCoord x=3 y=9 z=152\u003e\n#\u003cCoord x=7 y=7 z=152\u003e\n#\u003cCoord x=3 y=9 z=152\u003e\n#\u003cCoord x=7 y=7 z=152\u003e\n#\u003cCoord x=3 y=9 z=152\u003e\n#\u003cCoord x=7 y=7 z=152\u003e\n#\u003cCoord x=3 y=9 z=152\u003e\n#\u003cCoord x=7 y=7 z=152\u003e\n```","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492387531,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM4MTkzMg==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294381932"},"message":"Finally figured out how to clean up the jobs.\n\nI first walked each FellTree jobs to see if any tiles were marked for FellTree.  None were.  So these jobs existed without a corresponding tile.\n\nI cobbled together this, some of the code taken from advFort.lua:\n\n```\nfunction smart_job_delete( job )\n    local gref_types=df.general_ref_type\n    --TODO: unmark items as in job\n    for i,v in ipairs(job.general_refs) do\n        if v:getType()==gref_types.BUILDING_HOLDER then\n            local b=v:getBuilding()\n            if b then\n                --remove from building\n                for i,v in ipairs(b.jobs) do\n                    if v==job then\n                        b.jobs:erase(i)\n                        break\n                    end\n                end\n            else\n                print(\"Warning: building holder ref was invalid while deleting job\")\n            end\n        elseif v:getType()==gref_types.UNIT_WORKER then\n            local u=v:getUnit()\n            if u then\n                u.job.current_job =nil\n            else\n                print(\"Warning: unit worker ref was invalid while deleting job\")\n            end\n        else\n            print(\"Warning: failed to remove link from job with type:\",gref_types[v:getType()])\n        end\n    end\n    --unlink job\n    local link=job.list_link\n    if link.prev then\n        link.prev.next=link.next\n    end\n    if link.next then\n        link.next.prev=link.prev\n    end\n\t-- Don't delete the ptrs because I think something still is hanging on to them.\n    --link:delete()\n    --finally delete the job\n    --job:delete()\nend\n\nlocal job_link=df.global.world.job_list.next\n\nwhile job_link do\n    local job = job_link.item\n\tjob_link = job_link.next\n\tif job and job.job_type == 9 then\n\t\tdfhack.job.printJobDetails(job)\n\t\tsmart_job_delete(job)\n\tend\nend\n```\n\nI had to comment out the parts that actually freed the memory or the save crash -- my guess is there was a double free or something.  As long as the double linked list was trimmed, the save process saved the trimmed list.\n\nSo this might be a bug with both autounsuspend (make the tick much higher by like 500-1000), and autochop seems to be adding FellTree jobs to the job queue without tile designations.","files":null},{"type":3,"author":{"id":"6879b8f55db2bdc58a4a5acfa01cd947d04b59d2"},"timestamp":1492390439,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDM4NDQ4NA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294384484"},"message":"I can confirm when enabling autochop my chop jobs began spiraling again.  I had a burrow designated and enabled.   I asked for 200-400 trees.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492476167,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDYzODA4Mg==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294638082"},"message":"Yeah, it seems that autochop has some issues. Unfortunately, I'm not too familiar with it, so I don't know if I can fix them easily. A couple came up in #1030, which may or may not be related.\n\nIf you can run this save under multiple DF versions, it would be great to know when this issue started appearing (i.e. maybe checking 0.40.24, 0.42.06, and 0.43.05). I'm guessing you've saved this one under 0.43.03, though, which means your current save can't be backported to earlier versions. It still might be helpful to know if it happens in 0.43.05, though.\n\nIf nobody steps up who knows more about autochop within a week, I'll try my best to sort out what's going on with it (I'm fairly busy for the rest of this week).","files":null},{"type":3,"author":{"id":"0541b7dd92e4d9285c31215454cda686ef6b8a4e"},"timestamp":1492494777,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDY5NDM3MQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294694371"},"message":"This really has nothing to do with autounsuspend; it's entirely because autochop is spamming the living daylights out of the job queue, by constantly spawning `FellTree` jobs over and over again. See, e.g, #1014, #1018, #1030.\n\nI know what the problem and how to fix it on a high level, but it's more of a fix than I'm up to attempting right now. Basically, anything that, prior to 0.40, relied on map designations to check for a dig/chop/gather job now has to _also_ check job postings (and maybe also the job list, not sure on that), and anything that wants to cancel a dig/chop/gather job has to be prepared to remove entries from the job posting list. You can still queue new jobs by setting map designations, but you should mark the map dirty by setting `df.global.process_dig` when you do. The \"best\" solutions would be some convenience routines in one of dfhack's modules (`Map`, I suppose) for interrogating for, starting, and cancelling such jobs, since this is something that many different plugins do.\n\nI would strongly urge people not to use autochop until we get this issue fixed properly.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1492549293,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5NDk4MTU0Nw==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-294981547"},"message":"I know there's a bit of code to deal with postings in the Job module (from #741), so I'd put it there. Thanks for the information! I'll look into fixing it when I get a chance, hopefully this weekend.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1493502946,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5ODE5Njk1OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-298196959"},"message":"@rrauenza Looking over this again, a couple things I noticed:\n- It's possible that the Z levels reported by the game are different from the ones used internally - can you run `lua printall(df.global.cursor)` around trees and see if you get a `z` close to 151?\n- I think `dfhack.job.removeJob()` accomplishes something similar to your `smart_job_delete()`","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1493949617,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDEwNjk5MzI0NTk="},"added":["bug"],"removed":[]},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1493949701,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI5OTM1NDE5OA==","github-url":"https://github.com/DFHack/dfhack/issues/1076#issuecomment-299354198"},"message":"The root cause of this that @ab9rf mentioned has been fixed in 1e46945 and a527091. I'll increase the delay in autosuspend as well, but this should be fixed in the next release.","files":null},{"type":4,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1493949701,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MTA2OTkzMzE1Ng=="},"status":2}]}