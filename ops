{"version":1,"ops":[{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475260419,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgxOTQ3MQ==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250819471"},"message":"``` lua\ndfhack.gui.makeAnnouncement(df.announcement_type.CITIZEN_DEATH, {D_DISPLAY=true}, xyz2pos(1,2,3), 'test', COLOR_GREEN)\n```\n\n`xyz2pos(x,y,z)` is equivalent to `{x=x,y=y,z=z}`, so this should also work:\n\n``` lua\ndfhack.gui.makeAnnouncement(df.announcement_type.CITIZEN_DEATH, {D_DISPLAY=true},{x=1,y=2,z=3}, 'test', COLOR_GREEN)\n```\n\nThere's also a more complicated example in `plugins/lua/siege-engine.lua` or `hack/lua/plugins/siege-engine.lua`.","files":null},{"type":4,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475260419,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50ODA4ODU3Njc1"},"status":2},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475260463,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDgwODg1ODYwNA=="},"added":["lua"],"removed":[]},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475260575,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMDExOA==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250820118"},"message":"I tried `{x=x,y=y,z=z}`, and it didn't work.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475260622,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMDI5MQ==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250820291"},"message":"What other arguments did you pass?","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475260736,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMDcyOA==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250820728"},"message":"`dfhack.gui.makeAnnouncement(df.announcement_type.CANCEL_JOB, df.announcement_flags.D_DISPLAY, unit.pos, msg, COLOR_LIGHTRED)`\n\nWhen that didn't work:\n\n`dfhack.gui.makeAnnouncement(df.announcement_type.CANCEL_JOB, df.announcement_flags.D_DISPLAY, {x = unit.pos.x, y = unit.pos.y, z = unit.pos.z}, msg, COLOR_LIGHTRED)`\n\nThe error message indicated the position was the problem.","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475260904,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMTQwNQ==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250821405"},"message":"I also added a `new = true` in there after the first try failed (just in case), but no luck.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475260990,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMTczOA==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250821738"},"message":"Your `flags` argument is incorrect. df.announcement_flags is a bitfield, so you can't pass an integer. What exactly is the error you're getting, anyway? I just get\n\n```\n(interactive):1: Cannot write field (global).makeAnnouncement(): complex object.\n```\n\nI did get this, but only when I mixed up pos2xyz and xyz2pos:\n\n```\n./hack/lua/dfhack.lua:187: attempt to index a number value (local 'pos')\n```\n\nThat's just a result of passing something to pos2xyz() incorrectly.","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475261094,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMjA5OA==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250822098"},"message":"Something like your first error, but following the stack trace took me to the line where the position is assigned. Maybe the line number was off?","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475261232,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMjY3NQ==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250822675"},"message":"I'm not quite sure what you mean. I thought you were passing `unit.pos` directly into makeAnnouncement().\nAnyway, does fixing the flags argument work?","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475261525,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyMzg3Ng==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250823876"},"message":"\u003e I'm not quite sure what you mean. I thought you were passing unit.pos directly into makeAnnouncement().\n\nI tried that first, then I tried creating my own position table, neither one worked. The first time I got the error I followed the stack trace into native code and it took me to the line where the position was assigned, so I assumed that was what was causing the problem.\n\nI can't check to see if fixing the flags works, because I don't have DF on this computer... I can test it and get back to you on tuesday.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475261667,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyNDQ0Nw==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250824447"},"message":"I can't see any information in the Lua stack trace that would allow you to track down the exact line in question in the C++ code. And even if you could, the C++ function would never actually be called, because the Lua API catches invalid arguments before trying to call native code.","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475262114,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyNjI5Ng==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250826296"},"message":"Umm... What? The stack trace I got had line numbers and filenames for the Lua code, then more for native code (DFHack, not DF) that Lua had called into. A bit of looking found these files in the DFHack source distribution. I have no idea what stack traces you get, but the ones I get have all kinds of useful information. I ended up coding my own version of this function in pure Lua using the C++ version as a guide.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475262340,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyNzA5MQ==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250827091"},"message":"This is what I got with your attempt (in the interactive interpreter):\n\n```\n(interactive):1: Cannot write field (global).makeAnnouncement(): complex object.\nstack traceback:\n    [C]: in field 'makeAnnouncement'\n    (interactive):1: in main chunk\n    [C]: in function 'safecall'\n    ./hack/lua/dfhack.lua:401: in function 'dfhack.interpreter'\n    ../dfhack/scripts/lua.lua:74: in local 'f'\n    ./hack/lua/dfhack.lua:562: in function 'dfhack.run_script_with_env'\n    (...tail calls...)\n```\n\nEven if you did compile DFHack with debugging information and got Lua stack traces to show line numbers of native code, you wouldn't see anything in the makeAnnouncement() function in library/modules/Gui.cpp because it was never called.","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475262533,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MDgyNzg4Mw==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-250827883"},"message":"Well somehow I did, I have no idea how, but I did.\n\n... Weird, but that's what happened.\n\nAnyway, I'll have more information next tuesday.","files":null},{"type":3,"author":{"id":"19b7ca360314af743d1e7a87f80f13612af68292"},"timestamp":1475599349,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MTQ0MzQ2MA==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-251443460"},"message":"I was wr... I was wro... _ahem_ You were right.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1475607334,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDI1MTQ3OTY3Ng==","github-url":"https://github.com/DFHack/dfhack/issues/999#issuecomment-251479676"},"message":"To be fair, I had to look up that example, and I didn't even expect `{D_DISPLAY=true}` to work at first. Bitfields in Lua are friendlier than in C++, apparently.\n\nI might see if it's possible to give better error messages for stuff like this when I get a chance.","files":null}]}