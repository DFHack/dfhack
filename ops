{"version":1,"ops":[{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594224980,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM1MjYwMDAyMjM="},"added":["idea"],"removed":[]},{"type":3,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594281515,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NTk3MTEzNg==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-655971136"},"message":"The big problem here is to identify the trouble causing histfig. I don't know what method @quietust used to identify the histfig causing the issues, but for a script to really have any impact, you'd need to be able to identify the histfig to kill off.","files":null},{"type":3,"author":{"id":"5221f59e75ea9db114593bbdfb180b7354aef9ed"},"timestamp":1594307639,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NjE4NjQ0NA==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656186444"},"message":"The method I used was to attach to DF from within IDA and set a breakpoint just before the crash, such that one of the CPU registers contained a Unit pointer referring to the mother. Then I jumped to that memory location and Alt+Q'ed a Unit structure onto it so I could easily find all of the important fields (unit ID, histfig ID, and race).\n\nIt took a bunch of trial and error to find the ideal breakpoint location (0x140DDB52B for Win64, but you have to set it **before** attaching a debugger for the first time because the EXE gets rebased and all of the addresses change), and the breakpoint tripped multiple times before it got to the case where it crashed (so I had to write down about a dozen unit/histfig IDs before getting the right one).","files":null},{"type":6,"author":{"id":"5221f59e75ea9db114593bbdfb180b7354aef9ed"},"timestamp":1594307639,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg0NzE1NDI4"},"target":"c38f5ced91d77392dc87e748b393a9c47748ed9f867f46a64de80b7ab9b9b523","message":"The method I used was to attach to DF from within IDA and set a breakpoint just before the crash, such that one of the CPU registers contained a Unit pointer referring to the mother. Then I jumped to that memory location and Alt+Q'ed a `unitst` structure onto it (created by running the `codegen_c_hdr.pl` script from the `df_misc` repo and importing the resulting header file) so I could easily find all of the important fields (unit ID, histfig ID, and race).\n\nIt took a bunch of trial and error to find the ideal breakpoint location (0x140DDB52B for Win64, but you have to set it **before** attaching a debugger for the first time because the EXE gets rebased and all of the addresses change), and the breakpoint tripped multiple times before it got to the case where it crashed (so I had to write down about a dozen unit/histfig IDs before getting the right one).","files":null},{"type":3,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594307887,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NjE4OTQ4Mg==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656189482"},"message":"Thanks for that explanation, which, unfortunately, was approximately what I expected, i.e. a manual process that can't be replicated by a script.\nAtomic Chicken has found a couple of anon fields that may offer a better target for a script, though [(http://www.bay12forums.com/smf/index.php?topic=176846.0)]","files":null},{"type":6,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594307887,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg0NzE2NTk0"},"target":"c3216c5caa41db546815e2dff7b8a63c483e73ddad3a5c7eadbdb64d7f225aaf","message":"Thanks for that explanation, which, unfortunately, was approximately what I expected, i.e. a manual process that can't be replicated by a script.\nAtomic Chicken has found a couple of anon fields that may offer a better target for a script, though [](http://www.bay12forums.com/smf/index.php?topic=176846.0)","files":null},{"type":6,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594307982,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg0NzE3MDI3"},"target":"c3216c5caa41db546815e2dff7b8a63c483e73ddad3a5c7eadbdb64d7f225aaf","message":"Thanks for that explanation, which, unfortunately, was approximately what I expected, i.e. a manual process that can't be replicated by a script.\nAtomic Chicken has found a couple of anon fields that may offer a better target for a script, though [link](http://www.bay12forums.com/smf/index.php?topic=176846.0)","files":null},{"type":6,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594307998,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg0NzE3MTEy"},"target":"c3216c5caa41db546815e2dff7b8a63c483e73ddad3a5c7eadbdb64d7f225aaf","message":"Thanks for that explanation, which, unfortunately, was approximately what I expected, i.e. a manual process that can't be replicated by a script.\nAtomic Chicken has found a couple of anon fields that may offer a better target for a script, though [thread](http://www.bay12forums.com/smf/index.php?topic=176846.0)","files":null},{"type":3,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594376042,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NjU5OTUxNA==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656599514"},"message":"```function x ()\n  for i, hf in ipairs (df.global.world.history.figures) do\n    if hf.info and\n       hf.info.curse and\n       hf.info.wounds and hf.info.wounds.anon_1 \u003e= df.global.cur_year then\n      hf.info.wounds.anon_1 = -1\n      hf.info.wounds.anon_2 = -1\n      dfhack.println (\"Aborting pregnancy on cursed \" .. dfhack.TranslateName (hf.name, true) .. \"/\" .. dfhack.TranslateName (hf.name, false))\n    end\n  end\nend\n\nx ()\n```\n\nseems to avoid the crash in the two saves I've tested. Note that I don't know if something will happen when the hf enters the embark and the unit (presumably with its pregnancy info unchanged) gets loaded. From that perspective killing the unit might be safer.","files":null},{"type":6,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594376042,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg0OTI5ODkz"},"target":"5dbfdedac1a9f8040cb75832a721e6637b30bae76ff23a88f0fd487383a3a9fa","message":"```\nfunction x ()\n  for i, hf in ipairs (df.global.world.history.figures) do\n    if hf.info and\n       hf.info.curse and\n       hf.info.wounds and hf.info.wounds.anon_1 \u003e= df.global.cur_year then\n      hf.info.wounds.anon_1 = -1\n      hf.info.wounds.anon_2 = -1\n      dfhack.println (\"Aborting pregnancy on cursed \" .. dfhack.TranslateName (hf.name, true) .. \"/\" .. dfhack.TranslateName (hf.name, false))\n    end\n  end\nend\n\nx ()\n```\n\nseems to avoid the crash in the two saves I've tested. Note that I don't know if something will happen when the hf enters the embark and the unit (presumably with its pregnancy info unchanged) gets loaded. From that perspective killing the unit might be safer.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594397438,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njc1NzM5NQ==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656757395"},"message":"Any thoughts on good names for the anon fields? From the thread, it sounds like they're probably pregnancy-specific, so maybe `pregnancy_year` and `pregnancy_tick`?","files":null},{"type":3,"author":{"id":"df7feee793b3a4f60453609739052ef8e882d092"},"timestamp":1594397776,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njc2MDE0Nw==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656760147"},"message":"I'm somewhat hesitant when it comes to pregnancy_*, as that sound more like the time of initiation of the pregnancy than the time of giving birth (i.e. the end of it). \"give_birth_*\" is a bit awkward too, though.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594398157,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njc2MzE0MA==","github-url":"https://github.com/DFHack/dfhack/issues/1603#issuecomment-656763140"},"message":"I think it would be more consistent with https://github.com/DFHack/df-structures/blob/76c3c0daa7e681b40913e83c2849e9c49e2e04ab/df.units.xml#L669, though (although that only has a single `pregnancy_timer` field, apparently).","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594406447,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NjgyNTQ0OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656825449"},"message":"In one world a human male had the options, in the object testing arena (same raws) another one didn't.\n\nPlus I was unable to find anything relating to castes and forging capabilities.\n\nI think it might be something to do with civilisations and the world(gen) itself.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594408280,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njg0NDkyMw==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656844923"},"message":"Yeah, maybe it also has something to do with the civilization (e.g. I think civs might not always have access to iron)","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594410036,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njg1Njc3OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656856779"},"message":"Do you mean in terms of the raws themselves? Because when I did see it, I definitely was a human.\nThat was in a 550 (or was 250?) year old world\n\nthe other was a minimalist 2 years world w few civs but still.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594415816,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njg5NDk5NA==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656894994"},"message":"No, I mean a specific in-game civilization. The raws define what a civilization *could* have access to, but that can vary based on what happens during world generation. I'm a bit rusty on the details, but [here](https://dwarffortresswiki.org/index.php/DF2014:Trading#Dwarves) is a mention of this type of behavior from the wiki:\n\n\u003e If the trading civilization does not have access to iron, they can still bring steel (and steel goods) and pig iron bars, but will not bring iron products.\n\nI'm unsure exactly what the details are, or whether advfort is intended to check what a civ has access to (@warmist?). If you still have the save, you could upload it for diagnosis.","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594426150,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njk0NTM3NQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656945375"},"message":"Here's the world where I can't: https://drive.google.com/file/d/1mMLzAt2-S-8D9KgRQoFsYu_5pmJOWJy0/view?usp=sharing","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594426588,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1Njk0Njg1Nw==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-656946857"},"message":"And here's where I can, using a random adventurer and who's already standing on a (gui/hack-wish'd-in) MSforge: https://drive.google.com/file/d/1rloJCTS9eHi9V3weZA_WiXsEByaT4Ggd/view?usp=sharing","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594591122,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NzI4MTQ2MQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-657281461"},"message":"Does it vary from site-to-site?","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594596742,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NzI5MjA3Mw==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-657292073"},"message":"Right, so with some experimenting, it seems that the civilisation an adventurer is a citizen of is what matters. That can change if you retire somewhere because when you unretire you will be a citizen of that place.\n\nSo maybe I just need to make a dummy civilisation that \"has access\" to all the things.\nProblem is... I can't even find how to see civilisations in gm-editor.","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1594608636,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NzMzMDU0NA==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-657330544"},"message":"Civilizations are instances of `historical_entity` (although not all `historical_entity`s are civs). Adding a new one is probably pretty hard. It should be easier to give your current civ access to certain materials, although I'm not sure how to do this off the top of my head.","files":null},{"type":3,"author":{"id":"88b79c31fdfd52952dafcabb16168259734368cc"},"timestamp":1594656947,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1NzY1MzM5OA==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-657653398"},"message":"Advfort tries to be smart and setups the ui fields to be same as your adventurer. However that probably would cause issues for some adventurers...\n\nI (or anyone wanting to fix this) probably needs to find a good \"civ\" and race to use in `setupFields` function. However currently i'm not how to best select it in general case (i.e. if using a lot of mods?)","files":null},{"type":6,"author":{"id":"88b79c31fdfd52952dafcabb16168259734368cc"},"timestamp":1594656947,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg1NDIxNzQ1"},"target":"b66c2aaa2c5baacbbe3e42ed628e37bcb2f9aabff3813b98b92d058eac853273","message":"Advfort tries to be smart and setups the ui fields to be same as your adventurer. However that probably would cause issues for some adventurers...\n\nI (or anyone wanting to fix this) probably needs to find a good \"civ\" and race to use in `setupFields` function. However currently i'm not how to best select it in general case (i.e. if using a lot of mods?). Also it might be smart to allow to use current logic as currently it's not a bug per. se. but a feature - your animal man does not know how to forge :D.","files":null},{"type":6,"author":{"id":"88b79c31fdfd52952dafcabb16168259734368cc"},"timestamp":1594662506,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdElzc3VlQ29tbWVudEVkaXQ6Mzg1NDQ1OTM2"},"target":"b66c2aaa2c5baacbbe3e42ed628e37bcb2f9aabff3813b98b92d058eac853273","message":"Advfort tries to be smart and setups the ui fields to be same as your adventurer. However that probably would cause issues for some adventurers...\n\nI (or anyone wanting to fix this) probably needs to find a good \"civ\" and race to use in `setupFields` function. However currently i'm not sure  how to best select it in general case (i.e. if using a lot of mods?). Also it might be smart to leave current logic (e.g under a setting?) as currently it's not a bug per. se. but a feature - your animal man does not know how to forge :D.","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1594851463,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY1OTA0MzU1Nw==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-659043557"},"message":"I mean, it's 100% a caste of human, just with different ears and a tail (or three).\nIt's definitely based on what can be made at the place your adventurer belongs to-- the civ-- where you unretire/start from.","files":null},{"type":3,"author":{"id":"783e9ef5cb42dce41aad4509b3df351f0088fd08"},"timestamp":1595342649,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2MTkwNDY1Mw==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-661904653"},"message":"So yeah, been fiddling w/ it for a while-- you can make what a fortress with your civilisation can make.","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595344111,"metadata":{"github-id":"MDE0OlVubGFiZWxlZEV2ZW50MzU3MTc1NjY2NQ=="},"added":[],"removed":["bug"]},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595344111,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDM1NzE3NTY2Njc="},"added":["question"],"removed":[]},{"type":3,"author":{"id":"88b79c31fdfd52952dafcabb16168259734368cc"},"timestamp":1595364299,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2MjA5NjgzOQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-662096839"},"message":"I'm very sorry that i don't get to this... I think easiest quick fix would be to find a dwarf civ and set it in `setupFields`. That way you would not need to change your own civ but you would get access to all dwarven crafts.","files":null},{"type":3,"author":{"id":"88b79c31fdfd52952dafcabb16168259734368cc"},"timestamp":1595434676,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY2MjU0ODEzMQ==","github-url":"https://github.com/DFHack/dfhack/issues/1604#issuecomment-662548131"},"message":"Fixed this in [this pullreq](https://github.com/DFHack/scripts/pull/161)","files":null},{"type":4,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1595470398,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MzU3ODE4ODc3Mw=="},"status":2}]}