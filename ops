{"version":1,"ops":[{"type":3,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573079260,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUyOTY5OA==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550529698"},"message":"For some context, this came up while experimenting with running DF within a rootless podman container.","files":null},{"type":3,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573079829,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzMjgwNQ==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550532805"},"message":"Ah, I see. This is being done to disable address space randomization and you can't seem to run setarch at all without specifying a personality.\n\nIn this case, `setarch linux64 -R` works, where `x86_64` fails. I can't think of any reason not to use linux64 over x64_64. That might be a suitable fix?","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573081135,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzMjk5OQ==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550532999"},"message":"We don't just put random commands in the launcher script for fun. It looks like `setarch` was introduced in https://github.com/DFHack/dfhack/commit/c423bb6e8858559d044f21fb412dabe09ffbe35c for the purposes of disabling ASLR, which is extremely important, since DFHack on non-Windows can't handle ASLR.","files":null},{"type":6,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573081135,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNTAwMDEzNQ=="},"target":"0ca004d900ceeba49481c951a57cc058c219078ab2c24c52a49c365249f4456e","message":"~We don't just put random commands in the launcher script for fun.~ It looks like `setarch` was introduced in https://github.com/DFHack/dfhack/commit/c423bb6e8858559d044f21fb412dabe09ffbe35c for the purposes of disabling ASLR, which is extremely important, since DFHack on non-Windows can't handle ASLR.","files":null},{"type":3,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573079994,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzMzQ0OA==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550533448"},"message":"Please excuse my tone, I wasn't intending to imply it was done for giggles.\n\nAlso note I added a comment with just that realization about the same time you replied.\n\nUsing 'linux64' instead of 'x86_64' looks to solve the issue in containers, but I am not 100% if this will have any detrimental effect outside of one.","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573079994,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5MTEyNQ=="},"target":"f99f2de1f2aeb851529149ca72f1bf1d1fe203b9dac509148f9552985e6d2ba7","message":"Please excuse my tone, I wasn't intending to imply it was done for giggles.\n\nAlso note I added a comment with just that realization about the same time you replied.\n\nUsing 'linux64' instead of 'x86_64' looks to solve the issue in containers, but I am not 100% if this will have any detrimental effect outside of one.\n\nWe could maybe check `setarch --list` to see if it contains linux64, and use that - else fall back to x86_64?","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573080320,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzNTUwMQ==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550535501"},"message":"Yeah, I just saw your reply, thanks.\n\n\u003e In this case, `setarch linux64 -R` works, where `x86_64` fails. I can't think of any reason not to use linux64 over x64_64. That might be a suitable fix?\n\nIs there a list of valid architectures somewhere? This is the first time I've seen `linux64` mentioned as a valid option, and I'm wary of changing to that in case other systems don't support that. Plus, the DF executable is specifically built for x86-64 - is your container able to run DF?\n\nThe argument to `setarch` is currently determined at build time, because reliably detecting the architecture at runtime across distros/etc. proved to be difficult. `setarch --list` could work, though, assuming that's portable.","files":null},{"type":3,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080561,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzNjI2Ng==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550536266"},"message":"... and now it has stopped working, and I don't understand what changed in my environment to do so.\n\nBut it *did* work for several starts. Not sure what the heck is going on, there, or how to properly mitigate it beyond yelling at the Moby or CRI-O projects to allow \"changing\" the personality.","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080561,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5NTgxMA=="},"target":"0469a3d606ae0707e0925576513b39dc834abc7fb69ee311f962811ab87152a1","message":"... and now it has stopped working, and I don't understand what changed in my environment to do so.\n\nBut it *did* work for several starts. Not sure what the heck is going on, there, or how to properly mitigate it beyond yelling at the Moby or CRI-O projects to allow \"changing\" the personality. I don't think there's a way to disable this for a binary beyond usage of setarch, though I am looking for one. (disabling with sysctl wouldn't work either in the context of a container)","files":null},{"type":3,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080724,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzNzIxMg==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550537212"},"message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 5 years back.](https://github.com/karelzak/util-linux/commit/5edb0ea6bbd57dd916417737f98c9109dc1ecb5b)","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080724,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5NzA4Ng=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://github.com/karelzak/util-linux/commit/5d1607e260be44a03067f09cc2034d2208c713de)","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080775,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5NzQ1Nw=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/commit/?id=5d1607e260be44a03067f09cc2034d2208c713de)","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080885,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5ODM0OQ=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/commit/?id=5d1607e260be44a03067f09cc2034d2208c713de)\n\nSo it might be worth checking before running setarch, to catch odd environments and respond with a more helpful message than what setarch would supply (eg, someone trying to run the game on a raspberry pi with dfhack and getting this far before realizing it wasn't going to happen).","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573080977,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNDk5OTA1MQ=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/commit/?id=5d1607e260be44a03067f09cc2034d2208c713de)\n\nSo it might be worth checking before running setarch, to catch odd environments and respond with a more helpful message than what setarch would supply (eg, someone trying to run the game on a raspberry pi with dfhack and getting this far before realizing it wasn't going to happen).\n\nWe can probably close this, I don't see a good resolution in dfhack's scope (like I allude earlier, the real problem is on the container runtime side as you do have a very valid reason to need the `-R` argument.)\n\nUnless... unless a simple forking wrapper binary could be built and used to just add `ADDR_NO_RANDOMIZE`? I *think* that survives a fork()?","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573081397,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNTAwMjEyMQ=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/commit/?id=5d1607e260be44a03067f09cc2034d2208c713de)\n\nSo it might be worth checking before running setarch, to catch odd environments and respond with a more helpful message than what setarch would supply (eg, someone trying to run the game on a raspberry pi with dfhack and getting this far before realizing it wasn't going to happen - df is x86, and wouldn't run natively on ARM).","files":null},{"type":6,"author":{"id":"2db698130da1786957d2ab8d36b79f746d91090a"},"timestamp":1573081410,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDMwNTAwMjIzMQ=="},"target":"ecf8f5d4665229010f685ae659ab5475a311deed8aaf91fccf69f74bf515aec1","message":"As far as portability of `setarch --list` - this was added to the upstream util-linux codebase [about 7 years back.](https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/commit/?id=5d1607e260be44a03067f09cc2034d2208c713de)\n\nSo it might be worth checking before running setarch, to catch odd environments and respond with a more helpful message than what setarch would supply (eg, someone trying to run the game on a raspberry pi with dfhack and getting this far before realizing it wasn't going to happen (df is x86, and wouldn't run natively on ARM)).","files":null},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573081073,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MDUzOTQ1MQ==","github-url":"https://github.com/DFHack/dfhack/issues/1466#issuecomment-550539451"},"message":"I guess another thing we could try is `setarch some_arch -R true` to find an architecture that works before starting DF. Checking this on a Pi is an interesting idea too. I'll leave this open until we can come up with something a bit more robust.\n\nIn your case, I expect you can change the contents of `hack/dfhack_setarch.txt` to an architecture that works in your container (if you're able to find one... if it only works intermittently, I'm not sure how to deal with that from our end)","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573081093,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI3NzcxODMzMzQ="},"added":["os-specific"],"removed":[]},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573540479,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1Mjc1NTc2OA==","github-url":"https://github.com/DFHack/dfhack/issues/1467#issuecomment-552755768"},"message":"Depends on how portable it is. I take it you're the author?","files":null},{"type":3,"author":{"id":"e2662f15c02a8737bb99a5cfbf7579eaea5a0188"},"timestamp":1573544084,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1Mjc3MTQwMQ==","github-url":"https://github.com/DFHack/dfhack/issues/1467#issuecomment-552771401"},"message":"Yes.\nI made a lot of CheatEngine scripts for DF in the past, but most of them are for customization. Anyways, if you need more info on the actual issue I can provide you some.","files":null},{"type":5,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573660216,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI3OTU4MDQ1NzE="},"added":["idea"],"removed":[]},{"type":3,"author":{"id":"e77d0a5f059ed8eaaa1afef6624480d02a2f025a"},"timestamp":1573660676,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MzQ2Njc3NA==","github-url":"https://github.com/DFHack/dfhack/issues/1467#issuecomment-553466774"},"message":"I finally got time to download and look through this - I'm not entirely familiar with what you're using here, but it looks like some binary patches. We do have a [mechanism to support those](https://dfhack.readthedocs.io/en/stable/docs/Binpatches.html#binpatches), although it hasn't been used since 0.34.11. They're typically more annoying to maintain for all the DF builds we support, and require manual work for each new DF version, so we've been trying to use other methods instead.\nCould you explain what your fix is doing? There may be a \"cleaner\" way to accomplish this on the DFHack side that works across DF upgrades - e.g. we could try hooking into one or more virtual methods, or set up some task that runs repeatedly.","files":null},{"type":3,"author":{"id":"e2662f15c02a8737bb99a5cfbf7579eaea5a0188"},"timestamp":1573666856,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1MzUxOTQyNQ==","github-url":"https://github.com/DFHack/dfhack/issues/1467#issuecomment-553519425"},"message":"DF check unit's ability to equip an item by envoking... call it \"ItemEquipResult CanEquip(int itemTemplateID, int unitTemplateID)\", not exact on the actual argument list. This function returns 0, 1 or 2. I don't remember which one's which but it's most likely CANNOT_EQUIP, CAN_EQUIP_2H_ONLY, CAN_EQUIP_1H\nNow, the main point is that this function does not take actual unit as an argument, so I don't see an easy way to fix it. I had to hook it in all 3 places where it checks weapons: before CanEquip() is called to store unit reference (labels 'store1', 'store2', 'store3'), after to clean it up ('restore1', 'restore2', 'restore3') and inside CanEquip() to perform a check of weapon required size against actual unit's size (after tallness/broadness mods but before muscle/fat mods). It's not perfect way of fixing stuff of course, I just can't come up with a better solution\nI know binary patches are not included after 34.11, and I understand why, but I know little of DFHack functionality. So I figured better ask you if there is a way of implementing such a fix (tempfix, that is)\n\nIt's also funny how easily this could be fixed in actual source, but this \"CanEquip()\" method stays unchanged since at least 34.11 (had to make same fix there as well)","files":null}]}